#!/usr/bin/env node

/**
 * Customer Setup CLI Tool
 *
 * Automates the process of setting up a new customer from the template repo.
 *
 * Usage:
 *   node setup-customer.js --config ./new-customer.json
 *   node setup-customer.js --interactive
 *
 * What it does:
 *   1. Reads customer configuration from JSON file
 *   2. Updates src/config/company.ts with new company details
 *   3. Updates index.html (title, meta tags, OG images)
 *   4. Updates public/manifest.webmanifest (app name, colors)
 *   5. Updates capacitor.config.json (app ID)
 *   6. Updates .env (Supabase credentials)
 *   7. Updates src/index.css (brand colors)
 *   8. Optionally creates new GitHub repo
 */

import fs from 'fs';
import path from 'path';
import readline from 'readline';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ANSI colors for terminal output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m',
  cyan: '\x1b[36m',
};

const log = {
  info: (msg) => console.log(`${colors.blue}â„¹${colors.reset} ${msg}`),
  success: (msg) => console.log(`${colors.green}âœ“${colors.reset} ${msg}`),
  warn: (msg) => console.log(`${colors.yellow}âš ${colors.reset} ${msg}`),
  error: (msg) => console.log(`${colors.red}âœ—${colors.reset} ${msg}`),
  step: (msg) => console.log(`\n${colors.cyan}${colors.bright}â†’ ${msg}${colors.reset}`),
};

// Get the project root (two levels up from this script)
const PROJECT_ROOT = path.resolve(__dirname, '../..');

/**
 * Read and parse the customer configuration file
 */
function readConfig(configPath) {
  const fullPath = path.resolve(configPath);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Config file not found: ${fullPath}`);
  }
  const content = fs.readFileSync(fullPath, 'utf-8');
  return JSON.parse(content);
}

/**
 * Generate the company.ts file content
 */
function generateCompanyTs(config) {
  const { company, branding } = config;
  const addr = company.address;

  return `/**
 * Centralized Company Configuration
 *
 * Update this file when deploying for a new company.
 * All branding, contact info, and company details are managed here.
 *
 * Auto-generated by setup-customer CLI tool
 * Generated: ${new Date().toISOString()}
 */

export const companyConfig = {
  // Company Identity
  name: "${company.name}",

  // Website URL (for payment links, sharing, etc.)
  websiteUrl: "${company.websiteUrl || ''}",
  legalName: "${company.legalName}",
  shortName: "${company.shortName}",
  tagline: "${company.tagline || ''}",
  description: "${company.description || ''}",

  // Contact Information
  phone: "${company.phone}",
  phoneRaw: "${company.phoneRaw || company.phone.replace(/[^+\d]/g, '')}",
  email: "${company.email}",

  // Business Details
  licenseNumber: "${company.licenseNumber || ''}",
  address: {
    street: "${addr.street}",
    city: "${addr.city}",
    state: "${addr.state}",
    zip: "${addr.zip}",
    full: "${addr.street} ${addr.city}, ${addr.state} ${addr.zip}",
    region: "${addr.region || ''}",
  },

  // Hours of Operation
  hours: {
    weekdays: "${company.hours?.weekdays || 'Mon - Fri: 8AM - 5PM'}",
    weekends: "${company.hours?.weekends || 'Weekends: Closed'}",
    emergency: "${company.hours?.emergency || '24/7 Emergency Service'}",
    schema: "${company.hours?.schema || 'Mo-Fr 08:00-17:00'}",
  },

  // Service Areas
  serviceAreas: ${JSON.stringify(company.serviceAreas || [], null, 4).replace(/\n/g, '\n  ')},

  // Social Media Links
  social: {
    youtube: "${company.social?.youtube || ''}",
    instagram: "${company.social?.instagram || ''}",
    facebook: "${company.social?.facebook || ''}",
    tiktok: "${company.social?.tiktok || ''}",
    google: "${company.social?.google || ''}",
    yelp: "${company.social?.yelp || ''}",
    linkedin: "${company.social?.linkedin || ''}",
  },

  // Logo
  logo: "${branding?.logoPath || '/lovable-uploads/logo.png'}",

  // SEO Defaults
  seo: {
    defaultTitle: "${company.shortName} - ${company.tagline || 'Professional Services'}",
    defaultDescription: "${company.description || ''}",
    defaultKeywords: "${config.constructionType || 'construction'}, contractor, ${addr.region || addr.city}",
    siteName: "${company.shortName}",
    author: "${company.shortName}",
  },

  // Ratings
  ratings: {
    average: "5.0",
    count: "0",
    best: "5",
    worst: "1",
  },

  // Pricing
  priceRange: "$$-$$$",

  // Services (customize based on construction type)
  services: [
    { name: "Service 1", path: "/services/1" },
    { name: "Service 2", path: "/services/2" },
  ],

  // Warranty Info
  warranty: {
    years: 25,
    description: "25-year warranty covering materials and workmanship",
  },

  // Geo coordinates (for schema.org)
  coordinates: {
    lat: ${company.coordinates?.lat || 0},
    lng: ${company.coordinates?.lng || 0},
  },
} as const;

// Type for the company config
export type CompanyConfig = typeof companyConfig;
`;
}

/**
 * Update index.html with new branding
 */
function updateIndexHtml(config) {
  const htmlPath = path.join(PROJECT_ROOT, 'index.html');
  let html = fs.readFileSync(htmlPath, 'utf-8');

  const { company, branding } = config;

  // Update title
  html = html.replace(
    /<title>.*?<\/title>/,
    `<title>${company.shortName} - ${company.tagline || 'Professional Services'}</title>`
  );

  // Update meta description
  html = html.replace(
    /<meta name="description" content=".*?">/,
    `<meta name="description" content="${company.description || ''}">`
  );

  // Update meta author
  html = html.replace(
    /<meta name="author" content=".*?" \/>/,
    `<meta name="author" content="${company.shortName}" />`
  );

  // Update theme color
  if (branding?.colors?.themeColor) {
    html = html.replace(
      /<meta name="theme-color" content=".*?">/,
      `<meta name="theme-color" content="${branding.colors.themeColor}">`
    );
    html = html.replace(
      /<meta name="msapplication-TileColor" content=".*?">/,
      `<meta name="msapplication-TileColor" content="${branding.colors.themeColor}">`
    );
  }

  // Update apple-mobile-web-app-title
  html = html.replace(
    /<meta name="apple-mobile-web-app-title" content=".*?">/,
    `<meta name="apple-mobile-web-app-title" content="${company.shortName}">`
  );

  // Update OG tags
  html = html.replace(
    /<meta property="og:site_name" content=".*?" \/>/,
    `<meta property="og:site_name" content="${company.shortName}" />`
  );

  html = html.replace(
    /<meta property="og:title" content=".*?">/,
    `<meta property="og:title" content="${company.shortName} - ${company.tagline || ''}">`
  );

  html = html.replace(
    /<meta name="twitter:title" content=".*?">/,
    `<meta name="twitter:title" content="${company.shortName} - ${company.tagline || ''}">`
  );

  html = html.replace(
    /<meta property="og:description" content=".*?">/,
    `<meta property="og:description" content="${company.description || ''}">`
  );

  html = html.replace(
    /<meta name="twitter:description" content=".*?">/,
    `<meta name="twitter:description" content="${company.description || ''}">`
  );

  // Update OG image if provided
  if (branding?.ogImageUrl) {
    html = html.replace(
      /<meta property="og:image" content=".*?">/,
      `<meta property="og:image" content="${branding.ogImageUrl}">`
    );
    html = html.replace(
      /<meta name="twitter:image" content=".*?">/,
      `<meta name="twitter:image" content="${branding.ogImageUrl}">`
    );
  }

  // Update favicon if provided
  if (branding?.faviconUrl) {
    html = html.replace(
      /<link rel="icon" type="image\/x-icon" href=".*?">/,
      `<link rel="icon" type="image/x-icon" href="${branding.faviconUrl}">`
    );
  }

  fs.writeFileSync(htmlPath, html);
}

/**
 * Update manifest.webmanifest
 */
function updateManifest(config) {
  const manifestPath = path.join(PROJECT_ROOT, 'public/manifest.webmanifest');
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));

  const { company, branding } = config;

  manifest.name = company.name;
  manifest.short_name = company.shortName;
  manifest.description = company.description || '';

  if (branding?.colors?.themeColor) {
    manifest.theme_color = branding.colors.themeColor;
    manifest.background_color = branding.colors.themeColor;
  }

  fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
}

/**
 * Update capacitor.config.json
 */
function updateCapacitorConfig(config) {
  const capacitorPath = path.join(PROJECT_ROOT, 'capacitor.config.json');
  const capacitor = JSON.parse(fs.readFileSync(capacitorPath, 'utf-8'));

  if (config.app?.appId) {
    capacitor.appId = config.app.appId;
  }

  if (config.app?.repoName) {
    capacitor.appName = config.app.repoName;
  }

  fs.writeFileSync(capacitorPath, JSON.stringify(capacitor, null, 2));
}

/**
 * Update .env file with Supabase credentials
 */
function updateEnvFile(config) {
  const envPath = path.join(PROJECT_ROOT, '.env');
  const { supabase } = config;

  const envContent = `VITE_SUPABASE_PROJECT_ID="${supabase.projectId}"
VITE_SUPABASE_PUBLISHABLE_KEY="${supabase.publishableKey}"
VITE_SUPABASE_URL="${supabase.url}"
VITE_FUNCTIONS_BASE="${supabase.url}/functions/v1"
VITE_ENABLE_MAPLIBRE="0"
VITE_PROFIT_V2="1"
`;

  fs.writeFileSync(envPath, envContent);
}

/**
 * Update CSS variables for brand colors
 */
function updateCssColors(config) {
  const cssPath = path.join(PROJECT_ROOT, 'src/index.css');
  let css = fs.readFileSync(cssPath, 'utf-8');

  const { branding } = config;

  if (branding?.colors?.primary) {
    // Update primary color
    css = css.replace(
      /--primary: [\d\s%]+;/g,
      `--primary: ${branding.colors.primary};`
    );
  }

  if (branding?.colors?.accent) {
    // Update accent color
    css = css.replace(
      /--accent: [\d\s%]+;/g,
      `--accent: ${branding.colors.accent};`
    );
  }

  if (branding?.colors?.themeColor) {
    // Update splash screen gradient colors
    css = css.replace(
      /background: linear-gradient\(135deg, #[0-9a-fA-F]+ 0%, #[0-9a-fA-F]+ 50%, #[0-9a-fA-F]+ 100%\);/,
      `background: linear-gradient(135deg, ${branding.colors.themeColor} 0%, ${branding.colors.themeColor} 50%, ${branding.colors.themeColor} 100%);`
    );
  }

  fs.writeFileSync(cssPath, css);
}

/**
 * Interactive mode - prompt user for configuration
 */
async function interactiveMode() {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  const question = (prompt) => new Promise((resolve) => {
    rl.question(`${colors.cyan}?${colors.reset} ${prompt}: `, resolve);
  });

  console.log(`\n${colors.bright}ğŸ—ï¸  New Customer Setup Wizard${colors.reset}\n`);
  console.log('Answer the following questions to configure your new customer.\n');

  const config = {
    company: {
      address: {},
      hours: {},
      social: {},
      coordinates: {},
    },
    branding: {
      colors: {},
    },
    supabase: {},
    app: {},
  };

  // Company basics
  config.company.name = await question('Company name (e.g., "The Roofing Friend")');
  config.company.legalName = await question('Legal name (e.g., "THE ROOFING FRIEND, INC")');
  config.company.shortName = await question('Short name (e.g., "Roofing Friend")');
  config.company.tagline = await question('Tagline (optional)');
  config.company.phone = await question('Phone number (e.g., "(415) 697-1849")');
  config.company.email = await question('Email address');
  config.company.websiteUrl = await question('Website URL');
  config.company.licenseNumber = await question('License number (e.g., "CA License #1067709")');

  // Address
  console.log(`\n${colors.bright}Address:${colors.reset}`);
  config.company.address.street = await question('Street address');
  config.company.address.city = await question('City');
  config.company.address.state = await question('State');
  config.company.address.zip = await question('ZIP code');
  config.company.address.region = await question('Service region (e.g., "San Francisco Bay Area")');

  // Supabase
  console.log(`\n${colors.bright}Supabase Configuration:${colors.reset}`);
  config.supabase.projectId = await question('Supabase Project ID');
  config.supabase.publishableKey = await question('Supabase Publishable Key');
  config.supabase.url = `https://${config.supabase.projectId}.supabase.co`;

  // Branding
  console.log(`\n${colors.bright}Branding (optional - press Enter to skip):${colors.reset}`);
  config.branding.colors.themeColor = await question('Theme color hex (e.g., "#0b3040")') || '#0b3040';
  config.branding.colors.primary = await question('Primary color HSL (e.g., "205 50% 21%")') || '205 50% 21%';

  // App
  console.log(`\n${colors.bright}App Configuration:${colors.reset}`);
  config.app.repoName = await question('GitHub repo name for this customer');
  config.app.appId = await question('Capacitor App ID (e.g., "app.company.name")');

  rl.close();

  // Save config for reference
  const configPath = path.join(PROJECT_ROOT, 'tools/setup-customer', `${config.app.repoName || 'customer'}-config.json`);
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
  log.success(`Configuration saved to ${configPath}`);

  return config;
}

/**
 * Main function
 */
async function main() {
  console.log(`
${colors.bright}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ—ï¸  Customer Setup CLI Tool                         â•‘
â•‘           Automate new customer deployment                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}
`);

  const args = process.argv.slice(2);
  let config;

  // Parse arguments
  const configIndex = args.indexOf('--config');
  const isInteractive = args.includes('--interactive') || args.includes('-i');

  if (isInteractive) {
    config = await interactiveMode();
  } else if (configIndex !== -1 && args[configIndex + 1]) {
    const configPath = args[configIndex + 1];
    log.info(`Reading configuration from ${configPath}`);
    config = readConfig(configPath);
  } else {
    console.log(`
${colors.yellow}Usage:${colors.reset}
  node setup-customer.js --config ./customer-config.json
  node setup-customer.js --interactive

${colors.yellow}Options:${colors.reset}
  --config <path>    Path to customer configuration JSON file
  --interactive, -i  Run in interactive mode (prompts for input)

${colors.yellow}Example:${colors.reset}
  node setup-customer.js --config ./example-customer.json
`);
    process.exit(1);
  }

  // Validate config
  if (!config.company?.name || !config.supabase?.projectId) {
    log.error('Invalid configuration: company.name and supabase.projectId are required');
    process.exit(1);
  }

  log.info(`Setting up customer: ${colors.bright}${config.company.name}${colors.reset}`);

  // Step 1: Update company.ts
  log.step('Updating src/config/company.ts');
  const companyTsPath = path.join(PROJECT_ROOT, 'src/config/company.ts');
  fs.writeFileSync(companyTsPath, generateCompanyTs(config));
  log.success('Updated company configuration');

  // Step 2: Update index.html
  log.step('Updating index.html');
  updateIndexHtml(config);
  log.success('Updated HTML meta tags and branding');

  // Step 3: Update manifest
  log.step('Updating public/manifest.webmanifest');
  updateManifest(config);
  log.success('Updated PWA manifest');

  // Step 4: Update capacitor config
  log.step('Updating capacitor.config.json');
  updateCapacitorConfig(config);
  log.success('Updated Capacitor configuration');

  // Step 5: Update .env
  log.step('Updating .env');
  updateEnvFile(config);
  log.success('Updated environment variables');

  // Step 6: Update CSS colors
  if (config.branding?.colors) {
    log.step('Updating src/index.css brand colors');
    updateCssColors(config);
    log.success('Updated brand colors');
  }

  console.log(`
${colors.green}${colors.bright}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“ Customer setup complete!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}

${colors.yellow}Next steps:${colors.reset}
  1. Review the changes: ${colors.cyan}git diff${colors.reset}
  2. Add your logo to: ${colors.cyan}public/lovable-uploads/${colors.reset}
  3. Update icon files in: ${colors.cyan}public/icons/${colors.reset}
  4. Test locally: ${colors.cyan}npm run dev${colors.reset}
  5. Create new repo: ${colors.cyan}gh repo create ${config.app?.repoName || 'new-customer'} --private${colors.reset}
  6. Push changes: ${colors.cyan}git push -u origin main${colors.reset}
`);
}

main().catch((error) => {
  log.error(`Setup failed: ${error.message}`);
  process.exit(1);
});
